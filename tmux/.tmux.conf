# ===================================================================
# TMUX CONFIGURATION — ANTI-CRASH & STABLE
# ===================================================================

# --- CORE SETTINGS ---
unbind C-b
set -g prefix C-a
bind C-a send-prefix

set -g base-index 1
setw -g pane-base-index 1

# Đảm bảo hiển thị màu sắc chính xác trên i3wm/Terminal
set -g default-terminal "screen-256color"
set -as terminal-overrides ',*:Tc'

set -g mouse on
set -g history-limit 50000
set -sg escape-time 10  # Tránh lỗi nhận diện phím trên môi trường X11

# --- STABILITY ---
set -g automatic-rename off
setw -g automatic-rename off

# --- KEYBINDINGS ---
# Reload config nhanh
bind r source-file ~/.tmux.conf \; display-message "Config reloaded"

# Chia cửa sổ giữ nguyên đường dẫn hiện tại
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Di chuyển Pane nhanh bằng Alt + hjkl (không cần nhấn Prefix)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# --- STATUS LINE ---
set -g status-position bottom
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"
set -g status-left-length 50
set -g status-left "#[fg=yellow,bold] #S #[fg=white]| "

set -g window-status-current-format "#[fg=black,bg=yellow,bold] #I:#W #[default]"
set -g window-status-format "#[fg=white] #I:#W "

set -g status-right-length 100
set -g status-right "#[fg=cyan]%H:%M #[fg=white]| #[fg=green]#{user} "

# --- TPM & PLUGINS ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'

# --- CẤU HÌNH CHIẾN THUẬT AN TOÀN ---
# 1. KHÔNG tự động restore để tránh crash loop khi mở tmux
set -g @continuum-restore 'off'

# 2. VẪN tự động lưu sau mỗi 15 phút để bảo vệ dữ liệu
set -g @continuum-save-interval '15'

# 3. Lưu nội dung bên trong Pane
set -g @resurrect-capture-pane-contents 'on'

# 4. Phím tắt khôi phục thủ công: Prefix + Ctrl-R
# Phím tắt lưu thủ công: Prefix + Ctrl-S (Mặc định của resurrect)
bind S run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh' \; display-message "Manual Save Done!"

# --- KHỞI CHẠY TPM (LUÔN Ở CUỐI FILE) ---
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

run '~/.tmux/plugins/tpm/tpm'
